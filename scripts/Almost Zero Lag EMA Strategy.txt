//@version=5
strategy("Almost Zero Lag EMA Strategy", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10, initial_capital=100000)

// === Inputs ===
length = input.int(20, title="ZLEMA Length")
takeProfitPerc = {{TP}}
stopLossPerc = {{SL}}

// === ZLEMA Calculation ===
// ZLEMA is basically an EMA applied to de-lagged price: (2 * close - close[n])
lag = math.floor((length - 1) / 2)
price = 2 * close - close[lag]
zlema = ta.ema(price, length)

// === Entry Conditions ===
longCondition = ta.crossover(close, zlema)
shortCondition = ta.crossunder(close, zlema)

// === Exit Price Levels ===
longTP = strategy.position_avg_price * (1 + takeProfitPerc / 100)
longSL = strategy.position_avg_price * (1 - stopLossPerc / 100)

shortTP = strategy.position_avg_price * (1 - takeProfitPerc / 100)
shortSL = strategy.position_avg_price * (1 + stopLossPerc / 100)

// === Strategy Logic ===
if (longCondition)
    strategy.entry("Long", strategy.long)

if (shortCondition)
    strategy.entry("Short", strategy.short)

if (strategy.position_size > 0)
    strategy.exit("TP/SL Long", from_entry="Long", limit=longTP, stop=longSL)

if (strategy.position_size < 0)
    strategy.exit("TP/SL Short", from_entry="Short", limit=shortTP, stop=shortSL)

// === Plotting ===
plot(zlema, title="ZLEMA", color=color.orange, linewidth=2)
plot(close, title="Price", color=color.gray)
